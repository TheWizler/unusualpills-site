<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Your Cart</title>
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial;background:#0c0c0e;color:#f5f5f7;margin:0;padding:24px}
  table{width:100%;max-width:900px;margin:0 auto;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #26262c;text-align:left;vertical-align:middle}
  .actions{max-width:900px;margin:16px auto;display:flex;gap:12px;justify-content:space-between;align-items:center}
  button{background:#fff;color:#000;border:0;border-radius:999px;padding:10px 16px;cursor:pointer}
  a{color:#9ad}
  .muted{color:#9aa}
</style>
</head>
<body>
  <h1>Your Cart</h1>
  <table id="cartTable"></table>
  <div class="actions">
    <a href="/index.html">← Continue shopping</a>
    <div>
      <span id="promoPreview" class="muted"></span>
      <button id="checkoutBtn">Checkout</button>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);

// ---------- Normalization helpers (convert old cart shape) ----------
function normalizeCart(items){
  return (items||[]).map(i => ({
    id: i.id || i.slug || i.name,                // fallback if older shape
    name: i.name || '',
    price_cents: (typeof i.price_cents === 'number')
      ? i.price_cents
      : Math.round((i.price || 0) * 100),        // convert dollars -> cents
    currency: i.currency || 'usd',
    is_shirt: (typeof i.is_shirt === 'boolean')
      ? i.is_shirt
      : /tee|hoodie/i.test(String(i.name)),      // best-effort guess
    quantity: (typeof i.quantity === 'number')
      ? i.quantity
      : (i.qty || 1),                            // old field was qty
    size: i.size || null,
    color: i.color || null
  }));
}

function getCartRaw(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch(_){ return []; } }
function setCartRaw(c){ localStorage.setItem('cart', JSON.stringify(c)); }

// Always return a normalized cart; persist if changed
function getCart(){
  const current = getCartRaw();
  const normalized = normalizeCart(current);
  if (JSON.stringify(current) !== JSON.stringify(normalized)) {
    setCartRaw(normalized);
  }
  return normalized;
}

function setCart(c){ setCartRaw(normalizeCart(c)); render(); }

// ---------- Quantity ops ----------
function inc(id){ const c=getCart(); const i=c.find(x=>x.id===id); if(i){ i.quantity++; setCart(c);} }
function dec(id){ const c=getCart(); const i=c.find(x=>x.id===id); if(i){ i.quantity--; if(i.quantity<=0) c.splice(c.indexOf(i),1); setCart(c);} }
function removeItem(id){ const c=getCart().filter(x=>x.id!==id); setCart(c); }

// ---------- Promo math (preview only; real discount server-side) ----------
function promoPreview(cart){
  const units = [];
  cart.forEach(it=>{
    if (it.is_shirt) {
      for(let q=0;q<it.quantity;q++) units.push(it.price_cents);
    }
  });
  if (units.length < 4) return {freeCount:0, discountCents:0};
  const freeCount = Math.floor(units.length / 4) * 2;
  const discountCents = units.sort((a,b)=>a-b).slice(0, freeCount).reduce((s,p)=>s+p,0);
  return {freeCount, discountCents};
}

// ---------- Render ----------
function render(){
  const cart = getCart();
  if(cart.length===0){
    $('#cartTable').innerHTML = '<tr><td>Your cart is empty.</td></tr>';
    $('#promoPreview').textContent = '';
    return;
  }

  const rows = cart.map(i => `
    <tr>
      <td style="min-width:260px">${i.name}</td>
      <td>$ ${(i.price_cents/100).toFixed(2)}</td>
      <td>
        <button onclick="dec('${i.id}')">-</button>
        ${i.quantity}
        <button onclick="inc('${i.id}')">+</button>
        <button onclick="removeItem('${i.id}')">Remove</button>
      </td>
      <td>$ ${((i.price_cents*i.quantity)/100).toFixed(2)}</td>
    </tr>
  `).join('');

  const subtotal = cart.reduce((s,i)=>s+i.price_cents*i.quantity,0);
  const {freeCount, discountCents} = promoPreview(cart);
  const total = subtotal - discountCents;

  $('#cartTable').innerHTML = `
    <tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>
    ${rows}
    <tr><td colspan="3" style="text-align:right">Subtotal</td><td>$ ${(subtotal/100).toFixed(2)}</td></tr>
    <tr><td colspan="3" style="text-align:right">Promo discount (preview)</td><td>− $ ${(discountCents/100).toFixed(2)}</td></tr>
    <tr><td colspan="3" style="text-align:right"><strong>Estimated total</strong></td><td><strong>$ ${(total/100).toFixed(2)}</strong></td></tr>
  `;

  $('#promoPreview').textContent =
    freeCount>0 ? `Promo: ${freeCount} shirt${freeCount>1?'s':''} will be free at checkout (cheapest first).`
                : 'Add 4 shirts to trigger “Buy 2, Get 2 Free.”';
}
render();

// ---------- ONE checkout for the ENTIRE cart ----------
$('#checkoutBtn').addEventListener('click', async ()=>{
  const items = getCart();
  if (!items.length) return alert('Your cart is empty.');

  // Ensure is_shirt exists (normalizer should have done this)
  items.forEach(i => { if (typeof i.is_shirt === 'undefined') i.is_shirt = false; });

  try{
    const res = await fetch('/.netlify/functions/create-checkout', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ items })
    });
    const data = await res.json();
    if (data.url) { window.location = data.url; }
    else { throw new Error('No URL from checkout function'); }
  }catch(err){
    console.error(err);
    alert('Checkout error. Please try again.');
  }
});
</script>
</body>
</html>
