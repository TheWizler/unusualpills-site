<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Free Shirt | Unusual Pills</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0c0c12; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.16);
      --focus:#7dfcff; --text:#fff; --muted:rgba(255,255,255,.7); --accent:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,0,200,.12) 0%, transparent 60%),
        radial-gradient(800px 500px at 90% 90%, rgba(0,200,255,.14) 0%, transparent 70%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      display:flex; align-items:center; justify-content:center; padding:32px;
    }
    .card{
      width:min(880px, 96vw); background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--stroke); border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:24px;
    }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px }
    .brand-link{ display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit }
    .brand-link:hover{ opacity:.9 }
    .brand-link img{ width:40px; height:40px; border-radius:10px; object-fit:cover }
    h1{margin:0; font-size:28px; letter-spacing:.3px}
    .sub{margin-top:6px; color:var(--muted); font-size:14px}
    .header-right{ display:flex; align-items:center; gap:12px }
    .home-btn{
      padding:8px 12px; border-radius:12px; border:1px solid var(--stroke);
      background:#fff; color:#111; font-weight:800; text-decoration:none;
      transition: transform .05s ease, box-shadow .2s ease;
    }
    .home-btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(255,255,255,.15) }
    .home-btn:active{ transform:none; box-shadow:none }
    form{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:18px }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
    .full{ grid-column:1 / -1 }
    label{ display:block; font-size:12px; letter-spacing:.2px; color:var(--muted); margin-bottom:6px }
    input, select{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--stroke); background:rgba(0,0,0,.25); color:var(--text);
      outline:none; transition: box-shadow .2s, border-color .2s;
    }
    input:focus, select:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus) 30%, transparent);
    }
    .consent{ grid-column:1/-1; display:flex; align-items:flex-start; gap:12px; margin-top:8px; font-size:14px }
    .consent input{ width:auto; margin-top:4px }
    .actions{ grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px }
    .small{ color:var(--muted); font-size:12px }
    .btn{
      padding:12px 16px; border-radius:14px; border:1px solid var(--stroke);
      background:var(--accent); color:#111; font-weight:800; cursor:pointer;
      transition: transform .05s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 8px 24px rgba(255,255,255,.15) }
    .btn:active{ transform: translateY(0); box-shadow:none }
    .error{ display:none; background:#ff4d4d; color:#fff; padding:10px 12px; border-radius:10px; margin:8px 0 }
    .success{ display:none; background:#2ecc71; color:#111; padding:10px 12px; border-radius:10px; margin:8px 0 }
    @media (max-width:720px){
      form{ grid-template-columns:1fr } .row{ grid-template-columns:1fr }
      .actions{ flex-direction:column; align-items:stretch } .btn{ width:100% }
    }
  </style>
</head>
<body>
  <div class="card" role="region" aria-labelledby="title">
    <div class="header">
      <a class="brand-link" href="index.html" aria-label="Back to Home">
        <img src="static/images/merch.png" alt="Unusual Pills">
        <div>
          <h1 id="title">Free Shirt Signup</h1>
          <div class="sub">Verify your email and drop your shipping info. We’ll never sell your data.</div>
        </div>
      </a>
      <div class="header-right">
        <a class="home-btn" href="index.html">Home</a>
        <a class="small" href="mailto:hello@unusualpills.com" style="color:#fff">Contact us</a>
      </div>
    </div>

    <div id="err" class="error" role="alert"></div>
    <div id="ok"  class="success" role="status">Thanks! Check your email for a verification link…</div>

    <form id="shirtForm" autocomplete="on" novalidate>
      <div class="row">
        <div>
          <label for="first">First name</label>
          <input id="first" name="first_name" autocomplete="given-name" required>
        </div>
        <div>
          <label for="last">Last name</label>
          <input id="last" name="last_name" autocomplete="family-name" required>
        </div>
      </div>

      <div class="full">
        <label for="email">Email</label>
        <input id="email" type="email" name="email" autocomplete="email" inputmode="email" required>
      </div>

      <div class="full">
        <label for="address1">Address line 1</label>
        <input id="address1" name="address1" autocomplete="address-line1" required>
      </div>

      <div class="full">
        <label for="address2">Address line 2 (optional)</label>
        <input id="address2" name="address2" autocomplete="address-line2">
      </div>

      <div class="row">
        <div>
          <label for="city">City</label>
          <input id="city" name="city" autocomplete="address-level2" required>
        </div>
        <div>
          <label for="state">State/Region</label>
          <input id="state" name="state" autocomplete="address-level1" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="postal">Postal Code</label>
          <input id="postal" name="postal_code" autocomplete="postal-code" required>
        </div>
        <div>
          <label for="country">Country</label>
          <select id="country" name="country" autocomplete="country-name">
            <option>USA</option><option>Canada</option><option>UK</option><option>Australia</option>
          </select>
        </div>
      </div>

      <!-- NEW: Shirt Size -->
      <div class="row">
        <div class="full">
          <label for="size">Shirt size</label>
          <select id="size" name="shirt_size" required>
            <option value="" disabled selected>Select size</option>
            <option>XS</option>
            <option>S</option>
            <option>M</option>
            <option>L</option>
            <option>XL</option>
            <option>2XL</option>
            <option>3XL</option>
          </select>
        </div>
      </div>

      <div class="full">
        <label for="phone">Phone (optional)</label>
        <input id="phone" name="phone" autocomplete="tel">
      </div>

      <div class="consent">
        <input id="consent" type="checkbox" name="marketing_consent" required>
        <label for="consent">I agree to receive emails about new merch & drops from Unusual Pills. I can unsubscribe anytime.</label>
      </div>

      <div class="actions">
        <div class="small">By submitting, you allow us to email you and to use your details to ship your shirt.</div>
        <button id="submitBtn" class="btn" type="submit">Create Account & Claim</button>
      </div>
    </form>
  </div>

  <!-- Supabase + Formspree -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Supabase values (yours)
    const SUPABASE_URL  = "https://rkwldeocahwvnuzjhpgq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrd2xkZW9jYWh3dm51empocGdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDA2OTEsImV4cCI6MjA3MjIxNjY5MX0.WH_XmuIJ53DtMwMo2I7e4ul-m9BaTVlJMkMHY583oi0";

    // Formspree endpoint (for owner email notifications)
    const FORMSPREE_URL = "https://formspree.io/f/xldwnjan";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    const form = document.getElementById('shirtForm');
    const btn  = document.getElementById('submitBtn');
    const err  = document.getElementById('err');
    const ok   = document.getElementById('ok');
    const consent = document.getElementById('consent');

    function val(id){ return document.getElementById(id).value.trim(); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.style.display = 'none'; err.textContent = '';
      ok.style.display = 'none';

      if (!consent.checked) {
        err.textContent = 'Please check the email opt-in box to continue.';
        err.style.display = 'block';
        return;
      }

      // Basic size validation
      if (!val('size')) {
        err.textContent = 'Please select a shirt size.';
        err.style.display = 'block';
        return;
      }

      btn.disabled = true;

      const payload = {
        first_name: val('first'),
        last_name:  val('last'),
        email:      val('email'),
        address1:   val('address1'),
        address2:   val('address2'),
        city:       val('city'),
        state:      val('state'),
        postal_code:val('postal'),
        country:    document.getElementById('country').value,
        phone:      val('phone'),
        shirt_size: val('size'),
        marketing_consent: true
      };

      // 1) Send passwordless magic link (no password required)
      const { error: otpErr } = await sb.auth.signInWithOtp({
        email: payload.email,
        options: {
          emailRedirectTo: window.location.origin + '/thanks.html' // optional
        }
      });
      if (otpErr) {
        err.textContent = 'Signup failed: ' + otpErr.message;
        err.style.display = 'block';
        btn.disabled = false;
        return;
      }

      // 2) Save profile row (stores shipping info for you)
      const { error: insErr } = await sb.from('profiles').insert(payload);
      if (insErr) {
        err.textContent = 'Saving profile failed: ' + insErr.message;
        err.style.display = 'block';
        btn.disabled = false;
        return;
      }

      // 3) Email you via Formspree (non-blocking)
      try {
        const fd = new FormData();
        Object.entries(payload).forEach(([k,v]) => fd.append(k, v ?? ""));
        fd.append("_subject", "New Free Shirt Signup");
        await fetch(FORMSPREE_URL, { method: "POST", body: fd, headers: { "Accept": "application/json" } });
      } catch (_) { /* ignore */ }

      // 4) Success message + gentle redirect
      ok.style.display = 'block';
      setTimeout(() => { window.location.href = 'thanks.html'; }, 800);
    });
  </script>
</body>
</html>
